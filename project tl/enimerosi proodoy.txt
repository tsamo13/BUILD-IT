
from flask import Flask, request, jsonify, render_template, redirect, url_for
from datetime import datetime

app = Flask(__name__)

# Εικονικά δεδομένα έργων
projects_db = {
    "team1": [
        {"id": 1, "title": "Ανακαίνιση Κτιρίου Α"},
        {"id": 2, "title": "Τοποθέτηση Ηλιακών Πάνελ"},
    ]
}

MAX_MESSAGE_LENGTH = 300  # Όριο χαρακτήρων

@app.route("/projects/<team_id>", methods=["GET"])
def get_projects(team_id):
    # Επιστρέφει τα ενεργά έργα για το συγκεκριμένο συνεργείο
    projects = projects_db.get(team_id, [])
    return jsonify(projects)

@app.route("/submit_progress", methods=["POST"])
def submit_progress():
    data = request.json
    project_id = data.get("project_id")
    message = data.get("message")
    confirm = data.get("confirm")

    if not message or len(message.strip()) == 0:
        return jsonify({"status": "error", "message": "Το μήνυμα δεν μπορεί να είναι κενό."}), 400
    if len(message) > MAX_MESSAGE_LENGTH:
        return jsonify({"status": "error", "message": "Το μήνυμα ξεπερνά το επιτρεπτό όριο λέξεων."}), 400

    if not confirm:
        return jsonify({
            "status": "preview",
            "preview": f"Προεπισκόπηση για έργο #{project_id}: {message}"
        })

    return jsonify({
        "status": "success",
        "message": "Η ενημέρωση αποστάλθηκε επιτυχώς στην κατασκευαστική."
    })

# ---------- ΝΕΑ ΔΙΑΔΡΟΜΗ: Αναφορά Προβλήματος ----------

@app.route("/report_issue", methods=["GET", "POST"])
def report_issue():
    if request.method == "POST":
        new_date = request.form.get("new_date")
        issue_type = request.form.get("issue_type")
        issue_info = request.form.get("issue_info")

        # Εδώ γίνεται η αποθήκευση ή αποστολή (π.χ. σε βάση ή email)
        print(f"[REPORT] Νέα Ημ/νία: {new_date}, Τύπος: {issue_type}, Πληροφορίες: {issue_info}")

        return redirect(url_for("issue_submitted"))

    return render_template("report_issue.html")

@app.route("/issue_submitted")
def issue_submitted():
    return "Η αναφορά προβλήματος υποβλήθηκε επιτυχώς!"

if __name__ == "__main__":
    app.run(debug=True)
